
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head> 
  <meta charset="utf-8">
  <title>Self Updating Edison Apps - </title>
  <meta name="author" content="">

  
  <meta name="description" content="

  
  
    
      Self Updating Edison Apps
    
    
      
        










        
      
    
  


One of the challenges I have had in hand...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rwx.io/2015/08/18/self-updating-edison-app.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/css/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/js/search.min.js" type="text/javascript" charset="utf-8"></script>
  <link href="" rel="alternate" title="" type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>



 
  

  <style>html{background: linear-gradient(180deg, rgba(62, 54, 52,
  0.8) 0%, rgba(89, 79, 76, 0.8)),  url("/images/background.png") repeat;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Self Updating Edison Apps</h1>
    
    
      <p class="meta">
        









<time datetime="2015-08-18T10:49:00-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>One of the challenges I have had in handing out prototype devices is keeping the software up to date. Solutions like &lt;a href-“www.resin.io” target=”_blank”&gt;resin.io&lt;/a&gt; do a nice job of deploying <a href="http://bundler.io/" target="_blank">bundler images</a> onto devices like the Edison. The primary issue I had was the overhead of pushing bundler images around when the only thing that was changing was the node app. It seemed easier to just use git and npm to handle the updates. I may go the resin.io route later, but this early in dev and testing the git route seems simpler.</p>

<h2 id="overview-of-what-i-did">Overview of What I Did</h2>
<p>The product I am prototyping has two parts, an Edison device (with additional sensors and actuators) running a node app, and a node web service for managing device configuration and data running in the cloud.</p>

<ol>
  <li>The device’s node app is published in a private github repository.</li>
  <li>I installed and configured git on each of the Edison devices.</li>
  <li>I cloned the github repository onto each of the Edison devices.</li>
  <li>I installed the forever module on each of the devices to keep the app up and allow easy restarting of the app.</li>
  <li>I created a startup script that starts the app using forever.</li>
  <li>I created and enabled a linux service that runs the startup script on boot.</li>
  <li>I added code to the app to periodically ask the web service what the latest version of the app should be.</li>
  <li>If a new version is available the app will do a pull and use forever to do a restart using the new version.</li>
</ol>

<h2 id="the-details">The Details</h2>

<h3 id="initial-cleanup">Initial Cleanup</h3>

<ul>
  <li>Remove any app from the default Edison node_app_slot directory so you don’t accidentally start the app using the default Edison process.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>mv /node_app_slot /node_app_slotbk
mv  ~/.node_app_slot/ ~/.node_app_slotbk
</code></pre>
</div>

<h3 id="install-git">Install Git</h3>
<p>#### Update /etc/opkg/base-feeds.conf with these 3 lines
<code class="highlighter-rouge">
src all     http://iotdk.intel.com/repos/1.1/iotdk/all
src x86 http://iotdk.intel.com/repos/1.1/iotdk/x86
src i586    http://iotdk.intel.com/repos/1.1/iotdk/i586
</code>
#### Update opkg and install git
<code class="highlighter-rouge">
opkg update
opkg install git
</code></p>

<h3 id="option-1-modify-edisons-default-port">Option 1: Modify Edison’s default port</h3>
<p>I wanted to use port 80 for the node app so I moved the default Edison config service to port 8080</p>

<h4 id="change-default-port-in-edison-cofig-server">Change default port in edison-cofig-server</h4>

<p>Edit <em>/usr/lib/edison_config_tools/edison-config-server.js</em>
and change the last line to use a port other than 80.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http.createServer(requestHandler).listen(8080);
</code></pre>
</div>

<h4 id="option-2-disable-the-edison-config-web-service">Option 2: Disable the Edison config web service</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>systemctl disable edison_config
systemctl stop    edison_config
</code></pre>
</div>

<h3 id="setup-to-use-github">Setup to use github</h3>

<h4 id="generate-a-key-for-use-with-github">Generate a key for use with github</h4>
<ul>
  <li>ssh-keygen -t rsa -b 4096 -C “me@my.email”</li>
</ul>

<p>Follow the directions, easiest is just to hit return at the prompts. I chose to not do a passphrase for my small pilot.</p>

<h4 id="generate-a-deployment-key-for-the-github-repository">Generate a deployment key for the github repository</h4>
<ul>
  <li>Go to your app’s github repository, choose <em>settings</em>, choose <em>deployment keys</em></li>
  <li>Click the <em>Add Deployment Key</em> button</li>
  <li>Give it a title (the host name for the device works)</li>
  <li>Back on the Edison run cat /home/root/.ssh/id_rsa.pub to get the text for the public key</li>
  <li>copy the text for the public key to the <em>Key</em> input box back on github.</li>
</ul>

<h3 id="clone-your-repo">Clone your repo</h3>
<p>Back on the Edison</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd /
git clone &lt;your repo&gt; AppDirName
cd /AppDirName
</code></pre>
</div>

<h3 id="pull-latest-code">Pull Latest code</h3>
<p>Now any time you update code on master a simple <em>git pull</em> will update the latest code.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git pull
</code></pre>
</div>

<h3 id="install-forever-module-using-npm">Install forever module using npm</h3>
<p>Forever will automatically restart a node app if it crashes. It also has some handy restart features.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install -g forever
</code></pre>
</div>

<h3 id="create-a-startup-script--service">Create a startup script &amp; service</h3>
<p>Creating a startup service will allow your app to start automatically using forever.</p>

<h4 id="create-startupsh-to-start-node-app-serverjs-in-this-case">Create startup.sh to start node app (server.js in this case)</h4>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nb">cd</span> /AppDirName 
forever start server.js
</code></pre>
</div>

<h4 id="make-startupsh-executable">Make startup.sh executable</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>chmod +x startup.sh
</code></pre>
</div>

<h4 id="create-a-startup-service-file-at-libsystemdsystemstartupservice">Create a startup service file at /lib/systemd/system/startup.service</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[Unit]
 Description=STARTUP
 [Service]                           
 Type=idle                           
 RemainAfterExit=true
 ExecStart=/AppDirName/startup.sh
 Environment="HOME=/home/root"    
 WorkingDirectory=/AppDirName/   
 [Install]                     
 WantedBy=multi-user.target 
</code></pre>
</div>

<h4 id="enable-startup-service">Enable startup service</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>systemctl enable /lib/systemd/system/startup.service
</code></pre>
</div>

<h3 id="enable-your-node-app-to-update-itself">Enable your node app to update itself</h3>

<p>By using a simple update function you can get your app to update itself and restart.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var spawn = require('child_process').exec;
var semver = require('semver');
var bunyan = require('bunyan');
var log = bunyan.createLogger({
    name: 'app',
    streams: [{
        type: 'rotating-file',
        path: '/var/log/app.log',
        period: '1d',
        count: 7        
    }]
});
var pjson = require('./package.json');

var checkVersion = function(){
  var currentVersion = pjson.version;
  var options = {  hostname: 'www.myhost.com',
                             port: 80,
                   path: 'http://www.myhost.com/device_version/',
                   method: 'GET',
                   headers: {'Content-Type': 'application/json'}
                };
  var callback = function(response) {
    var dataStr = '';
    response.on('data', function (chunk) {
      dataStr += chunk;
    });

    response.on('end', function () {
      var versionInfo = JSON.parse(dataStr);
      var latestVersion = versionInfo.client_version || "0.0.0"; //don't update if missing version info
      log.info("current version: ", currentVersion);
      log.info("latest version: ", latestVersion);
      if (semver.gt(latestVersion, currentVersion)){
        log.info("pulling newer versions");
        spawn('git pull', function(error, stdout, stderr) {
          if (error){
            log.error("ERROR pulling latest: ", error);
          }
          else{
            log.info("updating packages");
            spawn('npm update', function(error, stdout, stderr){
              if (error){
                log.error("ERROR updating packages: ", error);
              }
              else {
                log.info("restarting node");
                spawn('forever restartall', function(error, stdout, stderr){
                  if (error){
                    log.error("ERROR restarting: ", error);
                  }
                  else {
                     log.info("restarted");
                  }
                });
              }           
            });
          }
        }); 
      }
    });
  };

//check for updates at app startup
checkVersion();

//then check for updates every hour;
setInterval(function() {
    checkVersion();                                                       
  }, 3600000);
  
</code></pre>
</div>

<h3 id="on-the-server">On the server</h3>
<p>You will need to add a route on your server to provide the version info. In this example the route was a GET request to the  <em>/device_version</em> route. For simplicity I just use an env_var on the service. I simply update the env_var when a new version is available. Then in the logic for the <em>/device_version</em> route I pass back the version found in the env_var.</p>

<p>The logic for comparing versions is very basic and flawed, but will work in this simple case.</p>

<h3 id="improvements">Improvements</h3>
<p>Ideally instead of a straight <em>git pull</em> you can instead download a tagged version, and keep the current and next version info for each device in the web service db. This would allow rolling out upgrades to specific devices, etc. Another approach would be to pass back version info to the device so updates could roll out immediately if the device is in use. Finally more logic on the device to schedule an update when not active would be ideal. In that case maybe adding more than <em>versionNumber</em> of the latest version to the server response, maybe a priority value also.</p>

<p>This was a quick experiment it getting updates to percolate out to devices prototype devices, and so far it seems to be working well.</p>

</div>


  <footer>
    <p class="meta">
      


      









<time datetime="2015-08-18T10:49:00-07:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2015/08/17/workbench.html" title="Previous Post: Workbench Replaces My Desk">&laquo; Workbench Replaces My Desk</a>
      
      
        <a class="basic-alignment right" href="/2015/09/09/esp8266-initial-notes.html" title="Next Post: ESP8266 Initial Notes">ESP8266 Initial Notes &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section id="titles">
  <a href="http://rwx.io" title=""><img id="logo" src="http://rwx.io/images/profile.jpg" /></a>
  <h1 id="site_title"><a href="http://rwx.io" title=""></a></h1>
  <h3 id="site_subtitle">Design, development, productivity -- notes and explorations.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://rwx.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://rwx.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://rwx.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://rwx.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<div id="search">
  <form action="/search" method="get">
    <input type="text" id="search-query" name="q" placeholder="Search" autocomplete="off">
  </form>
</div>

<section id="search-results" style="display: none;">
  <h1 id="search-results-heading">Search Results</h1>
  <div class="entries">
  </div>
</section>


<script id="search-results-template" type="text/mustache">
  <ul>
  {{#entries}}
      <li class="post">
        <a href="{{url}}">{{title}}</a>
      </li>
    </article>
  {{/entries}}
  </ul>
</script>


<script type="text/javascript">
  $(function() {
    $('#search-query').lunrSearch({
      indexUrl: '/js/index.json',   // Url for the .json file containing search index data
      results : '#search-results',  // selector for containing search results element
      entries : '.entries',         // selector for search entries containing element (contained within results above)
      template: '#search-results-template'  // selector for Mustache.js template
    });
  });
</script>

<section id="social">
  

  

  

  

  

  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/03/11/Org-Export-Configurations.html">Org Export Configurations</a>
      </li>
    
      <li class="post">
        <a href="/2016/03/10/Deft-and-Emacs-for-Notes.html">Deft + Org for Notes</a>
      </li>
    
      <li class="post">
        <a href="/2016/03/09/org-with-babel-node-updated.html">Org Mode ES2015+ Code Blocks (updated)</a>
      </li>
    
      <li class="post">
        <a href="/2016/01/27/ancs-example-on-blend-nano.html">ANCS Example on BLE Nano</a>
      </li>
    
      <li class="post">
        <a href="/2016/01/23/ancs-message-display.html">ANCS Message Display</a>
      </li>
    
      <li class="post">
        <a href="/2015/10/06/org-with-babel-node.html">Org Mode ES2015+ Code Blocks</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/09/esp8266-initial-notes.html">ESP8266 Initial Notes</a>
      </li>
    
      <li class="post">
        <a href="/2015/08/18/self-updating-edison-app.html">Self Updating Edison Apps</a>
      </li>
    
      <li class="post">
        <a href="/2015/08/17/workbench.html">Workbench Replaces My Desk</a>
      </li>
    
      <li class="post">
        <a href="/2015/08/17/i2c-mpu-6050.html">I2C MPU-6050</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Popular Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/03/11/Org-Export-Configurations.html">Org Export Configurations</a>
      </li>
    
      <li class="post">
        <a href="/emacs/productivity/2013/03/04/nvalt-and-emacs.html">nvALT and Emacs</a>
      </li>
    
      <li class="post">
        <a href="/hacks/productivity/2012/01/17/screen-capture-goodness-dot-dot-dot.html">Screen capture goodness...</a>
      </li>
    
      <li class="post">
        <a href="/rubymotion/restkit/2013/03/07/getting-rklogconfigurebyname-working-in-rubymotion.html">Getting RKLogConfigureByName working in RubyMotion</a>
      </li>
    
      <li class="post">
        <a href="/hacks/productivity/2012/12/17/wiki-plus-searchable-notes.html">Wiki + searchable notes.</a>
      </li>
    
      <li class="post">
        <a href="/development/rubymotion/ios/2013/06/01/coredata-dot-sqldebug-for-rubymotion.html">CoreData.SQLDebug for RubyMotion</a>
      </li>
    
      <li class="post">
        <a href="/parsers/2012/12/30/treetop-and-parsing-expression-grammars-pegs.html">Treetop and Parsing Expression Grammars (PEGs)</a>
      </li>
    
      <li class="post">
        <a href="/poggr/google-docs/polymer/2014/10/15/spreadsheet-driven-web-apps.html">Spreadsheet Driven Web Apps</a>
      </li>
    
      <li class="post">
        <a href="/hacks/design/2013/01/01/user-stories-and-activity-diagrams.html">User Stories and Activity Diagrams</a>
      </li>
    
      <li class="post">
        <a href="/poggr/literate-coffee-script/2014/10/15/fun-with-literate-coffeescript.html">Fun with Literate CoffeeScript</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
