
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Org Mode ES2015+ Code Blocks (updated) - </title>
  <meta name="author" content="Patrick Goddi">

  
  <meta name="description" content="Note: In this post I have updated the instructions for use with Babel 6x. For Babel 5x see the original post. Babel 6x is a significant change from &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fooqri.github.io/blog/2016/03/09/org-with-babel-node-updated/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="" type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>




  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41376488-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <style>html{background: linear-gradient(180deg, rgba(62, 54, 52,
  0.8) 0%, rgba(89, 79, 76, 0.8)),  url("/images/background.png") repeat;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fooqri.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Org Mode ES2015+ Code Blocks (Updated)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-03-09T16:57:00-08:00" pubdate data-updated="true">Mar 9<span>th</span>, 2016</time>
        
      </p>
    
  </header>


<div class="entry-content"><ul>
<li><strong>Note:</strong> In this post I have updated the instructions for use with <em>Babel 6x</em>. For <em>Babel 5x</em> see the <a href="/blog/2015/10/06/org-with-babel-node/">original post</a>.</li>
</ul>


<p>Babel 6x is a significant change from Babel 5x, as the <em>cli</em> is now a separate node module called <em>babel-cli</em> and transforms are now also delivered as separate packages.</p>

<p>First make a few changes to the emacs environment so you can use JavaScript in <strong>org mode</strong>, as well as find local <em>node.js</em> modules you have installed. Replace <em>&ldquo;~/org/node_modules&rdquo;</em> in the configuration below with the location of any local node modules you want to use. Using this approach you don&rsquo;t have to pollute the global node_module directory if you don&rsquo;t want to.</p>

<p>Add the following to your emacs init.el file and evaluate it (or restart emacs).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(setenv "NODE_PATH"
</span><span class='line'>  (concat
</span><span class='line'>   "~/org/node_modules" ":"
</span><span class='line'>   (getenv "NODE_PATH")
</span><span class='line'>  )
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>(org-babel-do-load-languages
</span><span class='line'> 'org-babel-load-languages
</span><span class='line'> '((js . t)))</span></code></pre></td></tr></table></div></figure>


<p>You can choose to install the Babel modules globally, or you can do it locally. In this example I will install them locally in the org directory (~/org/node_modules).</p>

<p>Next install the <em>babel-cli</em> module, this allows you to call Babel from the command line. You will also want to install the transforms you plan to use, the example below installs the common preset transforms used with <em>Babel 6</em>. Also install any local modules you need to use. I chose to install them from the ~/org directory where my notes are kept, but anywhere works as long as you have the correct path to <em>node_modules</em> set above.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install --save-dev babel-cli
</span><span class='line'>npm install --save-dev babel-preset-es2015
</span><span class='line'>npm install --save-dev babel-preset-stage-0
</span><span class='line'>npm install --save-dev babel-preset-stage-1
</span><span class='line'>npm install --save-dev babel-preset-stage-2
</span><span class='line'>npm install --save-dev babel-preset-stage-3
</span><span class='line'>npm install --save-dev babel-preset-react
</span><span class='line'>npm install --save-dev mongodb
</span><span class='line'>npm install --save-dev bluebird</span></code></pre></td></tr></table></div></figure>


<p>Next you want to set up a symbolic link to the <em>babel-cli</em> script you just installed so it can be found from the command line. I decided to call it <em>org-babel-node</em> so it won&rsquo;t interfere with a <em>babel-node</em> executable linked to a global module of the same name.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ln -s ~/org/node_modules/babel-cli/bin/babel-node.js /usr/local/bin/org-babel-node</span></code></pre></td></tr></table></div></figure>


<p>The default org-mode interpreter for JavaScript is <em>Node</em>, so you need to have that installed and its path set. But the cool thing is that you can change the interpreter inline in your code blocks in the cases you want to experiment with upcoming language features. To do this you simply tell <em>org mode</em> to use an alternative interpreter; in this case the <strong>babel-node</strong> transpiler installed earlier and linked as <em>org-babel-node</em>.</p>

<p>Adding  <em>:cmd &ldquo;org-babel-node&rdquo;</em>   after the  <em>#+begin_src js</em> tells <em>org mode</em> to use the <em>org-babel-node</em> transpiler instead of the default JavaScript interpreter. Because <em>Babel 6</em> uses external modules for transforms you need to also tell Babel which preset or plugins you wish to use with either the <strong>&mdash;presets</strong> or <strong>&mdash;plugins</strong> options. The <em>:results output</em> tells <em>org mode</em> that the results will be from an output statement <em>(using console.log() for JavaScript)</em></p>

<pre><code>   #+name: db.activities.findOne
   #+begin_src js :cmd "org-babel-node --presets stage-1" :results output drawer
      (async function(){
          try {
              let MongoDB = require('mongodb');
              let Promise = require('bluebird');
              Promise.promisifyAll(MongoDB);
              let db = await MongoDB.MongoClient.connectAsync(process.env.MY_DB);
              let activityCol = db.collection('activities')
              let result = await activityCol.findOne();
              db.close();
              console.log(`The first activity name is ${result.name}`);
            }
           catch(err){
             consule.log(err);
             throw err;
           }
         })()
   #+END_SRC
</code></pre>

<p>Now, simply place the cursor anywhere in the block and execute it using C-c C-c. The results will be placed under the block in second block entitled: <em>#+RESULTS:</em></p>

<p>The block can be executed as often as you like and the results will be refreshed. See the updated example with its results block below.</p>

<pre><code>   #+name: db.activities.findOne
   #+begin_src js :cmd "org-babel-node --presets stage-1" :results output drawer
      (async function(){
          try {
              let MongoDB = require('mongodb');
              let Promise = require('bluebird');
              Promise.promisifyAll(MongoDB);
              let db = await MongoDB.MongoClient.connectAsync(process.env.MY_DB);
              let activityCol = db.collection('activities')
              let result = await activityCol.findOne();
              db.close();
              console.log(`The first activity name is ${result.name}`);
            }
           catch(err){
             consule.log(err);
             throw err;
           }
         })()
   #+END_SRC

   #+RESULTS: db.activities.findOne
   :RESULTS:
   The first activity name is Shopping
   :END:
</code></pre>

<p>You can see several new and experimental language features including <em>async functions</em>, the <em>await</em> keyword for performing a non-blocking wait on a promise to complete, and <em>template strings</em>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Patrick Goddi</span></span>

      








  


<time datetime="2016-03-09T16:57:00-08:00" pubdate data-updated="true">Mar 9<span>th</span>, 2016</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://fooqri.github.io/blog/2016/03/09/org-with-babel-node-updated/" data-via="" data-counturl="http://fooqri.github.io/blog/2016/03/09/org-with-babel-node-updated/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/01/27/ancs-example-on-blend-nano/" title="Previous Post: ANCS Example on BLE Nano">&laquo; ANCS Example on BLE Nano</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/03/10/Deft-and-Emacs-for-Notes/" title="Next Post: Deft and Emacs for Notes">Deft and Emacs for Notes &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="titles">
  <a href="http://fooqri.github.io" title=""><img id="logo" src="http://fooqri.github.io/images/profile.jpg" /></a>
  <h1 id="site_title"><a href="http://fooqri.github.io" title=""></a></h1>
  <h3 id="site_subtitle">Design, development, productivity -- notes and explorations.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://fooqri.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://fooqri.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://fooqri.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://fooqri.github.io/atom.xml"> Feed </a></li> 
    <li><i class="fa fa-twitter fa-lg"></i><a href="https://twitter.com/fooqri"> twitter </a></li>
    <li><i class="fa fa-linkedin fa-lg"></i><a href="http://www.linkedin.com/in/goddi/"> LinkedIn </a></li> </ul>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/03/10/Deft-and-Emacs-for-Notes/">Deft and Emacs for Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/09/org-with-babel-node-updated/">Org Mode ES2015+ Code Blocks (updated)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/27/ancs-example-on-blend-nano/">ANCS Example on BLE Nano</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/23/ancs-message-display/">ANCS Message Display</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/06/org-with-babel-node/">Org Mode ES2015+ Code Blocks</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Popular Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/17/screen-capture-goodness-dot-dot-dot/">Screen capture goodness...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/fast-photosync-from-iphone/">Fast PhotoSync from iPhone</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/wiki-plus-searchable-notes/">Wiki + searchable notes.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/26/foldingtext-and-productivity/">FoldingText and productivity</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/30/treetop-and-parsing-expression-grammars-pegs/">Treetop and Parsing Expression Grammars (PEGs)</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Patrick Goddi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'goddio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://fooqri.github.io/blog/2016/03/09/org-with-babel-node-updated/';
        var disqus_url = 'http://fooqri.github.io/blog/2016/03/09/org-with-babel-node-updated/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
